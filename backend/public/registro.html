<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro Nuevo Alumno</title>

<link rel="stylesheet" href="/style.css">


</head>

<body>

<nav>
  <div class="nav-logo"><img src="/logo.png"></div>
  <div class="nav-links">
    <a href="index.html">Inicio</a>
  </div>
</nav>

<div class="container">

<h2>üìù Registro Nuevo Alumno</h2>

<form id="formRegistro">

<!-- ================= CURP ================= -->
<fieldset>
<legend>Validaci√≥n por CURP</legend>

<div class="row">
  <input id="curp" class="sin-icono" maxlength="18" placeholder="CURP" required>
  <button type="button" onclick="validarCURP()">Validar CURP</button>
</div>

<div class="row-3">
  <input id="fecha_nacimiento" readonly>
  <input id="edad" readonly>
  <input id="sexo" readonly>
</div>
</fieldset>


<!-- ================= DATOS PERSONALES ================= -->
<fieldset>
<legend>Datos Personales</legend>

<div class="row-3">
  <input id="nombres" placeholder="Nombres" required>
  <input id="apellido1" placeholder="Primer apellido" required>
  <input id="apellido2" placeholder="Segundo apellido" required>
</div>

<div class="row-3">
  <select id="estado"></select>
  <select id="municipio" disabled></select>
  <select id="ciudad" disabled></select>
</div>

</fieldset>


<!-- ================= PARAESCOLAR ================= -->
<fieldset>
<legend>Selecciona Paraescolar</legend>

<select id="paraescolar" required>
  <option value="">Cargando cupos...</option>
</select>

</fieldset>


<button type="submit">Guardar Registro</button>

</form>
</div>



<!-- ================= SCRIPTS ================= -->

<script src="/catalogo.json"></script>

<script>

/* ================= CURP ================= */
curp.addEventListener("input", ()=> curp.value = curp.value.toUpperCase());

function validarCURP(){
  const c = curp.value;
  const regex=/^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[A-Z0-9]{2}$/;

  if(!regex.test(c)){
    alert("CURP inv√°lida");
    return;
  }

  const y=c.substring(4,6);
  const m=c.substring(6,8);
  const d=c.substring(8,10);

  const full=(y<=new Date().getFullYear()%100?"20":"19")+y;

  fecha_nacimiento.value=`${full}-${m}-${d}`;

  const edadCalc=new Date().getFullYear()-full;
  edad.value=edadCalc;

  sexo.value=c[10]==="H"?"Masculino":"Femenino";
}


/* ================= CUPOS (REUTILIZA TU BACKEND) ================= */
async function cargarCupos(){

  const resp=await fetch("/api/paraescolar/cupos");
  const cupos=await resp.json();

  const lista=[
    "AJEDREZ","ATLETISMO","BANDA DE GUERRA","BASQUETBOL",
    "DANZA","ESCOLTA DE BANDERA","FOTOGRAF√çA","FUTBOL",
    "PINTURA","TEATRO-CANTO","TOCHO BANDERA","VOLEIBOL",
    "ORATORIA Y DECLAMACI√ìN","M√öSICA"
  ];

  paraescolar.innerHTML=`<option value="">Selecciona</option>`;

  lista.forEach(p=>{
    const disp=cupos[p]??50;

    const op=document.createElement("option");
    op.value=p;

    if(disp<=0){
      op.disabled=true;
      op.textContent=`${p} (LLENO)`;
    }else{
      op.textContent=`${p} (${disp} disponibles)`;
    }

    paraescolar.appendChild(op);
  });
}
cargarCupos();



/* ================= ESTADOS (usa tu catalogo existente) ================= */

fetch("/catalogo.json")
.then(r=>r.json())
.then(data=>{

  estado.innerHTML=`<option value="">Estado</option>`;

  data.forEach(e=>{
    const op=new Option(e.nombre,e.nombre);
    estado.appendChild(op);
  });

  estado.onchange=()=>{
    municipio.disabled=false;
    municipio.innerHTML=`<option>Municipio</option>`;

    const est=data.find(x=>x.nombre===estado.value);

    est.municipios.forEach(m=>{
      municipio.appendChild(new Option(m.nombre,m.nombre));
    });
  };

});


/* ================= GUARDAR ================= */
formRegistro.addEventListener("submit",async e=>{
  e.preventDefault();

  const body={
    curp:curp.value,
    nombre:`${nombres.value} ${apellido1.value} ${apellido2.value}`,
    paraescolar:paraescolar.value
  };

  const resp=await fetch("/api/paraescolar/registro-online",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });

  if(resp.ok) alert("Registro guardado üéâ");
});

</script>

</body>
</html>
