<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro Nuevo Alumno</title>

<link rel="stylesheet" href="/style.css">
<style>
.container{max-width:1000px;margin:40px auto}
.row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px}

.sin-icono:valid,
.sin-icono:invalid{
  background-image:none!important;
  padding-right:12px!important;
}
</style>

</head>

<body>

<nav>
  <div class="nav-logo"><img src="/logo.png"></div>
  <div class="nav-links">
    <a href="index.html">Inicio</a>
  </div>
</nav>

<div class="container">

<h2>üìù Registro Nuevo Alumno</h2>

<form id="formRegistro">

<!-- ================= CURP ================= -->
<fieldset>
<legend>Validaci√≥n por CURP</legend>

<div class="row">
  <input id="curp" class="sin-icono" maxlength="18" placeholder="CURP" required>
  <button type="button" onclick="validarCURP()">Validar CURP</button>
</div>

<div class="row-3">
  <input id="fecha_nacimiento" readonly>
  <input id="edad" readonly>
  <input id="sexo" readonly>
</div>
</fieldset>


<!-- ================= DATOS PERSONALES ================= -->
<fieldset>
<legend>Datos Personales</legend>

<div class="row-3">
  <input id="nombres" placeholder="Nombres" required>
  <input id="apellido1" placeholder="Primer apellido" required>
  <input id="apellido2" placeholder="Segundo apellido" required>
</div>

<div class="row-3">
  <select id="estado"></select>
  <select id="municipio" disabled></select>
  <select id="ciudad" disabled></select>
</div>

</fieldset>


<!-- ================= PARAESCOLAR ================= -->
<fieldset>
<legend>Selecciona Paraescolar</legend>

<select id="paraescolar" required>
  <option value="">Cargando cupos...</option>
</select>

</fieldset>


<button type="submit">Guardar Registro</button>
  <div id="resultadoRegistro" style="margin-top:20px;font-weight:bold;"></div>


</form>
</div>



<!-- ================= SCRIPTS ================= -->

<script src="/catalogo.json"></script>

<script>

/* ================= CURP ================= */
curp.addEventListener("input", ()=> curp.value = curp.value.toUpperCase());

function validarCURP(){
  const c = curp.value;
  const regex=/^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[A-Z0-9]{2}$/;

  if(!regex.test(c)){
    alert("CURP inv√°lida");
    return;
  }

  const y=c.substring(4,6);
  const m=c.substring(6,8);
  const d=c.substring(8,10);

  const full=(y<=new Date().getFullYear()%100?"20":"19")+y;

  fecha_nacimiento.value=`${full}-${m}-${d}`;

  const edadCalc=new Date().getFullYear()-full;
  edad.value=edadCalc;

  sexo.value=c[10]==="H"?"Masculino":"Femenino";
}


/* ================= CUPOS (REUTILIZA TU BACKEND) ================= */
async function cargarCupos(){

  const resp=await fetch("/api/paraescolar/cupos");
  const cupos=await resp.json();

  const lista=[
    "AJEDREZ","ATLETISMO","BANDA DE GUERRA","BASQUETBOL",
    "DANZA","ESCOLTA DE BANDERA","FOTOGRAF√çA","FUTBOL",
    "PINTURA","TEATRO-CANTO","TOCHO BANDERA","VOLEIBOL",
    "ORATORIA Y DECLAMACI√ìN","M√öSICA"
  ];

  paraescolar.innerHTML=`<option value="">Selecciona</option>`;

  lista.forEach(p=>{
    const disp=cupos[p]??50;

    const op=document.createElement("option");
    op.value=p;

    if(disp<=0){
      op.disabled=true;
      op.textContent=`${p} (LLENO)`;
    }else{
      op.textContent=`${p} (${disp} disponibles)`;
    }

    paraescolar.appendChild(op);
  });
}
cargarCupos();



/* ================= ESTADOS (usa tu catalogo existente) ================= */

fetch("/catalogo.json")
.then(r=>r.json())
.then(data=>{

  estado.innerHTML=`<option value="">Estado</option>`;

  data.forEach(e=>{
    const op=new Option(e.nombre,e.nombre);
    estado.appendChild(op);
  });

  estado.onchange=()=>{
    municipio.disabled=false;
    municipio.innerHTML=`<option>Municipio</option>`;

    const est=data.find(x=>x.nombre===estado.value);

    est.municipios.forEach(m=>{
      municipio.appendChild(new Option(m.nombre,m.nombre));
    });
  };

});


/* ================= GUARDAR ================= */
formRegistro.addEventListener("submit", async e=>{
  e.preventDefault();

  const datos = {
    curp: curp.value,
    nombres: nombres.value,
    primer_apellido: apellido1.value,
    segundo_apellido: apellido2.value,
    sexo: sexo.value,
    fecha_nacimiento: fecha_nacimiento.value,
    edad: edad.value,
    estado_nacimiento: estado.value,
    municipio_nacimiento: municipio.value,
    ciudad_nacimiento: ciudad.value,
    paraescolar: paraescolar.value
  };

  try{

    const resp = await fetch("/api/guardar", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(datos)
    });

    const result = await resp.json();

    // ‚ùå error backend
    if(result.error){
      alert(result.error);
      return;
    }

    // ===============================
    // ‚úÖ REGISTRO EXITOSO
    // ===============================

    // mostrar n√∫mero
    resultadoRegistro.innerHTML = `
      ‚úÖ Registro completado<br>
      üéì Tu n√∫mero de control es:
      <span style="color:#800000;font-size:20px">
        ${result.numero_control}
      </span>
    `;

    // deshabilitar TODO el formulario
    const inputs = formRegistro.querySelectorAll("input, select, button");

    inputs.forEach(i => i.disabled = true);

    // abrir PDF autom√°tico
    if(result.pdfUrl){
      window.open(result.pdfUrl, "_blank");
    }

  }catch(err){
    alert("Error del servidor");
    console.error(err);
  }
});


</script>

  <script>
formRegistro.addEventListener("submit", async e=>{
  e.preventDefault();

  const datos = {
    curp: curp.value,
    nombres: nombres.value,
    primer_apellido: apellido1.value,
    segundo_apellido: apellido2.value,
    sexo: sexo.value,
    fecha_nacimiento: fecha_nacimiento.value,
    edad: edad.value,
    estado_nacimiento: estado.value,
    municipio_nacimiento: municipio.value,
    ciudad_nacimiento: ciudad.value,
    paraescolar: paraescolar.value
  };

  const resp = await fetch("/api/guardar", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(datos)
  });

  const result = await resp.json();

  if(result.pdfUrl){
    window.open(result.pdfUrl, "_blank");
    alert("Registro guardado correctamente");
  }else{
    alert(result.error || "Error al guardar");
  }
});
</script>



  <script>
const estadosCURP = {
  AS:"AGUASCALIENTES", BC:"BAJA CALIFORNIA", BS:"BAJA CALIFORNIA SUR",
  CC:"CAMPECHE", CL:"COAHUILA", CM:"COLIMA", CS:"CHIAPAS", CH:"CHIHUAHUA",
  DF:"CIUDAD DE MEXICO", DG:"DURANGO", GT:"GUANAJUATO", GR:"GUERRERO",
  HG:"HIDALGO", JC:"JALISCO", MC:"MEXICO", MN:"MICHOACAN", MS:"MORELOS",
  NT:"NAYARIT", NL:"NUEVO LEON", OC:"OAXACA", PL:"PUEBLA", QT:"QUERETARO",
  QR:"QUINTANA ROO", SP:"SAN LUIS POTOSI", SL:"SINALOA", SR:"SONORA",
  TC:"TABASCO", TS:"TAMAULIPAS", TL:"TLAXCALA", VZ:"VERACRUZ",
  YN:"YUCATAN", ZS:"ZACATECAS"
};

function autocompletarEstado(curp){
  if(curp.length !== 18) return;

  const clave = curp.substring(11,13);
  const estadoTexto = estadosCURP[clave];

  if(estadoTexto){
    document.getElementById("estado").value = estadoTexto;
  }
}

curp.addEventListener("input", e=>{
  autocompletarEstado(e.target.value.toUpperCase());
});
</script>
<script>
function extraerDatosCURP(curp){

  const y = curp.substring(4,6);
  const m = curp.substring(6,8);
  const d = curp.substring(8,10);

  const full = (y <= new Date().getFullYear()%100 ? "20":"19")+y;

  const fecha = `${full}-${m}-${d}`;

  const hoy = new Date();
  let edad = hoy.getFullYear() - full;

  const sexo = curp[10] === "H" ? "Masculino":"Femenino";

  return { fecha, edad, sexo };
}

curp.addEventListener("input", ()=>{
  if(curp.value.length===18){
    const d = extraerDatosCURP(curp.value);
    fecha_nacimiento.value = d.fecha;
    edad.value = d.edad;
    sexo.value = d.sexo;
  }
});
</script>


</body>
</html>
