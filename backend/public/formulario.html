<!DOCTYPE html>
<html lang="es">
<head>
 
 <link rel="stylesheet" href="/style.css"> 
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <meta charset="UTF-8">
  <title>Formulario de Alumno</title>
</head>
<body>
 <nav>
  <div class="nav-logo">
    <img src="/logo.png" alt="Logo" />
  </div>
  <div class="nav-links">
    <a href="index.html">Inicio</a>
    <a href="login.html">Iniciar sesión</a>
  </div>
</nav>

 <h2>Formulario de Registro</h2>
<form id="registroForm">
<!-- Fieldsets integrados -->
<fieldset>
  <legend>Datos del Alumno</legend>
  <input type="text" name="nombres" placeholder="Nombres" required>
  <input type="text" name="primer_apellido" placeholder="Primer Apellido" required>
  <input type="text" name="segundo_apellido" placeholder="Segundo Apellido" required>
  <input type="text" name="curp" placeholder="CURP" required>
  <input type="text" name="carrera" placeholder="Carrera" required>
  <input type="text" name="periodo_semestral" placeholder="Periodo Semestral" value="2025-2026" required>
  <input type="text" name="semestre" placeholder="Semestre" value="Primer Semestre" required>
  <input type="text" name="grupo" placeholder="Grupo">
  <select name="turno" required>
    <option value="">Selecciona turno</option>
    <option value="matutino">Matutino</option>
    <option value="vespertino">Vespertino</option>
  </select>

  <label for="fecha_nacimiento" style="font-size: 14px; margin-top: 1px;">Fecha de Nacimiento:</label>
  <input type="date" id="fecha_nacimiento"  name="fecha_nacimiento" placeholder="Fecha de Nacimiento">
  
  <input type="text" name="edad" placeholder="Edad">

  <select name="sexo" required>
    <option value="">Selecciona sexo</option>
    <option value="femenino">Femenino</option>
    <option value="masculino">Masculino</option>
  </select>

  <select name="estado_nacimiento" required>
    <option value="">Selecciona estado</option>
    <option value="1">1 - AGUASCALIENTES</option>
    <option value="2">2 - BAJA CALIFORNIA</option>
    <option value="3">3 - BAJA CALIFORNIA SUR</option>
    <option value="4">4 - CAMPECHE</option>
    <option value="5">5 - COAHUILA</option>
    <option value="6">6 - COLIMA</option>
    <option value="7">7 - CHIAPAS</option>
    <option value="8">8 - CHIHUAHUA</option>
    <option value="9">9 - CIUDAD DE MEXICO</option>
    <option value="10">10 - DURANGO</option>
    <option value="11">11 - GUANAJUATO</option>
    <option value="12">12 - GUERRERO</option>
    <option value="13">13 - HIDALGO</option>
    <option value="14">14 - JALISCO</option>
    <option value="15">15 - MEXICO</option>
    <option value="16">16 - MICHOACAN</option>
    <option value="17">17 - MORELOS</option>
    <option value="18">18 - NAYARIT</option>
    <option value="19">19 - NUEVO LEON</option>
    <option value="20">20 - OAXACA</option>
    <option value="21">21 - PUEBLA</option>
    <option value="22">22 - QUERETARO</option>
    <option value="23">23 - QUINTANA ROO</option>
    <option value="24">24 - SAN LUIS POTOSI</option>
    <option value="25">25 - SINALOA</option>
    <option value="26">26 - SONORA</option>
    <option value="27">27 - TABASCO</option>
    <option value="28">28 - TAMAULIPAS</option>
    <option value="29">29 - TLAXCALA</option>
    <option value="30">30 - VERACRUZ</option>
    <option value="31">31 - YUCATAN</option>
    <option value="32">32 - ZACATECAS</option>
  </select>

  <input type="text" name="municipio_nacimiento" placeholder="Municipio de Nacimiento">
  <input type="text" name="ciudad_nacimiento" placeholder="Ciudad de Nacimiento">
  <input type="text" name="estado_civil" placeholder="Estado Civil">
</fieldset>


<fieldset>
  <legend>Datos Generales</legend>
  <input type="text" name="colonia" placeholder="Colonia">
  <input type="text" name="domicilio" placeholder="Domicilio">
  <input type="text" name="codigo_postal" placeholder="Código Postal">
  <input type="text" name="telefono_alumno" placeholder="Teléfono">
  <input type="email" name="correo_alumno" placeholder="Correo" required>
  <input type="text" name="tipo_sangre" placeholder="Tipo de Sangre">
  <input type="text" name="contacto_emergencia_nombre" placeholder="Contacto de Emergencia - Nombre">
  <input type="text" name="contacto_emergencia_telefono" placeholder="Contacto de Emergencia - Teléfono">


  <select name="habla_lengua_indigena_respuesta" required>
    <option value="">¿Habla lengua indígena? (Sí/No)</option>
    <option value="si">Sí</option>
    <option value="no">No</option>
  </select>

  <input type="text" name="habla_lengua_indigena_cual" placeholder="¿Cuál lengua?">
</fieldset>

<fieldset>
  <legend>Datos Médicos</legend>
  <input type="text" name="numero_seguro_social" placeholder="Número de Seguro Social">
  <select name="Unidad Medica" required>
  <option value="">Selecciona Unidad Medica</option>
  <option value="13">13</option>
  <option value="14">14</option>
  <option value="15">15</option>
  <option value="16">16</option>
  <option value="19">19</option>
</select>
  <input type="text" name="enfermedad_cronica_o_alergia_respuesta" placeholder="¿Tiene enfermedad o alergia? (Sí/No)">
  <input type="text" name="enfermedad_cronica_o_alergia_detalle" placeholder="Detalle enfermedad o alergia">
  <select name="discapacidad" required>
  <option value="">Selecciona discapacidad</option>
    <option value="Ninguna">Ninguna</option>
  <option value="Visual">Visual</option>
  <option value="Motriz">Motriz</option>
  <option value="Auditiva">Auditiva</option>
  <option value="Habla">Habla</option>
  <option value="Otro">Otro</option>
</select>
</fieldset>

<fieldset>
  <legend>Secundaria de Origen</legend>
  <input type="text" name="nombre_secundaria" placeholder="Nombre de Secundaria">
  <select name="regimen" required>
    <option value="">Selecciona régimen</option>
    <option value="publica">Pública</option>
    <option value="privada">Privada</option>
  </select>
  <input type="number" step="0.01" name="promedio_general" placeholder="Promedio General">
  <select name="modalidad" required>
    <option value="">Selecciona modalidad</option>
    <option value="general">General</option>
    <option value="tecnica">Técnica</option>
    <option value="abierta">Abierta</option>
    <option value="telesecundaria">Telesecundaria</option>
    <option value="ceneval">CENEVAL</option>
    <option value="inea">INEA</option>
    <option value="modular">Modular</option>
  </select>
</fieldset>

<fieldset>
  <legend>Tutor Responsable</legend>
  <input type="text" name="nombre_padre" placeholder="Nombre del Padre">
  <input type="text" name="telefono_padre" placeholder="Teléfono del Padre">
  <input type="text" name="nombre_madre" placeholder="Nombre de la Madre">
  <input type="text" name="telefono_madre" placeholder="Teléfono de la Madre">
  <select name="vive_con" required>
    <option value="">¿Con quién vive?</option>
    <option value="padres">Padres</option>
    <option value="mama">Mamá</option>
    <option value="papa">Papá</option>
    <option value="abuelos">Abuelos</option>
    <option value="tios">Tíos</option>
  </select>
  <input type="text" name="persona_emergencia_nombre" placeholder="Persona Emergencia - Nombre">
  <input type="text" name="persona_emergencia_parentesco" placeholder="Persona Emergencia - Parentesco">
  <input type="text" name="persona_emergencia_telefono" placeholder="Persona Emergencia - Teléfono">
</fieldset>


 

<fieldset>
  <legend>Selecciona un Paraescolar</legend>
  <label for="paraescolar">Paraescolar:</label>
  <select name="paraescolar" id="paraescolar" required>
    <option value="">--Selecciona--</option>
    <option value="AJEDREZ">AJEDREZ</option>
    <option value="ATLETISMO">ATLETISMO</option>
    <option value="BANDA DE GUERRA">BANDA DE GUERRA</option>
    <option value="BASQUETBOL">BASQUETBOL</option>
    <option value="DANZA">DANZA</option>
    <option value="ESCOLTA DE BANDERA">ESCOLTA DE BANDERA</option>
    <option value="FOTOGRAFÍA">FOTOGRAFÍA</option>
    <option value="FUTBOL">FUTBOL</option>
    <option value="PINTURA">PINTURA</option>
    <option value="TEATRO-CANTO">TEATRO-CANTO</option>
    <option value="TOCHO BANDERA">TOCHO BANDERA</option>
    <option value="VOLEIBOL">VOLEIBOL</option>
  </select>
</fieldset>
  <button type="submit">Guardar</button>

</form>

<script>
  const BASE_URL = window.location.origin.includes('localhost')
    ? 'http://localhost:3001'
    : 'https://registro272.onrender.com';

  window.onload = () => {
    const datos = JSON.parse(localStorage.getItem('datosPrecargados'));
    if (!datos) return;

    const set = (name, value) => {
      const input = document.querySelector(`[name="${name}"]`);
      if (input && value != null && value !== '') input.value = value;
    };

    // Autocompletar campos (igual que antes)
    const mappings = {
      ...datos.datos_alumno,
      ...datos.datos_generales,
      ...datos.datos_medicos,
      ...datos.secundaria_origen,
      ...datos.tutor_responsable,
      'habla_lengua_indigena_respuesta': datos.datos_generales?.habla_lengua_indigena?.respuesta,
      'habla_lengua_indigena_cual': datos.datos_generales?.habla_lengua_indigena?.cual,
      'enfermedad_cronica_o_alergia_respuesta': datos.datos_medicos?.enfermedad_cronica_o_alergia?.respuesta,
      'enfermedad_cronica_o_alergia_detalle': datos.datos_medicos?.enfermedad_cronica_o_alergia?.detalle,
      'persona_emergencia_nombre': datos.tutor_responsable?.persona_emergencia?.nombre,
      'persona_emergencia_parentesco': datos.tutor_responsable?.persona_emergencia?.parentesco,
      'persona_emergencia_telefono': datos.tutor_responsable?.persona_emergencia?.telefono
    };

    Object.entries(mappings).forEach(([k, v]) => set(k, v));
  };

  document.getElementById('registroForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const camposObligatorios = [
      'nombres','primer_apellido','segundo_apellido','curp','carrera',
      'periodo_semestral','semestre','turno','fecha_nacimiento','edad','sexo',
      'estado_nacimiento','municipio_nacimiento','ciudad_nacimiento','estado_civil',
      'colonia','domicilio','codigo_postal','telefono_alumno','correo_alumno',
      'tipo_sangre','contacto_emergencia_nombre','contacto_emergencia_telefono',
      'habla_lengua_indigena_respuesta',
      'numero_seguro_social','enfermedad_cronica_o_alergia_respuesta',
      'enfermedad_cronica_o_alergia_detalle','discapacidad',
      'nombre_secundaria','regimen','promedio_general','modalidad',
      'nombre_padre','telefono_padre','nombre_madre','telefono_madre',
      'vive_con','persona_emergencia_nombre','persona_emergencia_parentesco','persona_emergencia_telefono'
    ];

    for (const campo of camposObligatorios) {
      const input = document.querySelector(`[name="${campo}"]`);
      if (!input || !input.value.trim()) {
        alert(`⚠️ Por favor completa el campo: ${campo.replaceAll('_', ' ')}`);
        input?.focus();
        return;
      }
    }

    const folio = localStorage.getItem('alumnoFolio');
    if (!folio) return alert('Folio perdido');

    const formData = new FormData(e.target);
    const nuevoRegistro = {
      folio,
      datos_alumno: {
        nombres: formData.get('nombres'),
        primer_apellido: formData.get('primer_apellido'),
        segundo_apellido: formData.get('segundo_apellido'),
        curp: formData.get('curp'),
        carrera: formData.get('carrera'),
        periodo_semestral: formData.get('periodo_semestral'),
        semestre: formData.get('semestre'),
        grupo: formData.get('grupo'),
        turno: formData.get('turno'),
        fecha_nacimiento: formData.get('fecha_nacimiento'),
        edad: formData.get('edad'),
        sexo: formData.get('sexo'),
        estado_nacimiento: formData.get('estado_nacimiento'),
        municipio_nacimiento: formData.get('municipio_nacimiento'),
        ciudad_nacimiento: formData.get('ciudad_nacimiento'),
        estado_civil: formData.get('estado_civil')
      },
      datos_generales: {
        colonia: formData.get('colonia'),
        domicilio: formData.get('domicilio'),
        codigo_postal: formData.get('codigo_postal'),
        telefono_alumno: formData.get('telefono_alumno'),
        correo_alumno: formData.get('correo_alumno'),
       paraescolar: formData.get('paraescolar'),
        tipo_sangre: formData.get('tipo_sangre'),
        contacto_emergencia_nombre: formData.get('contacto_emergencia_nombre'),
        contacto_emergencia_telefono: formData.get('contacto_emergencia_telefono'),
        habla_lengua_indigena: {
          respuesta: formData.get('habla_lengua_indigena_respuesta'),
          cual: formData.get('habla_lengua_indigena_cual')
        }
      },
      datos_medicos: {
        numero_seguro_social: formData.get('numero_seguro_social'),
        unidad_medica_familiar: formData.get('unidad_medica_familiar'),
        enfermedad_cronica_o_alergia: {
          respuesta: formData.get('enfermedad_cronica_o_alergia_respuesta'),
          detalle: formData.get('enfermedad_cronica_o_alergia_detalle')
        },
        discapacidad: formData.get('discapacidad')
      },
      secundaria_origen: {
        nombre_secundaria: formData.get('nombre_secundaria'),
        regimen: formData.get('regimen'),
        promedio_general: formData.get('promedio_general'),
        modalidad: formData.get('modalidad')
      },
      tutor_responsable: {
        nombre_padre: formData.get('nombre_padre'),
        telefono_padre: formData.get('telefono_padre'),
        nombre_madre: formData.get('nombre_madre'),
        telefono_madre: formData.get('telefono_madre'),
        vive_con: formData.get('vive_con'),
        persona_emergencia: {
          nombre: formData.get('persona_emergencia_nombre'),
          parentesco: formData.get('persona_emergencia_parentesco'),
          telefono: formData.get('persona_emergencia_telefono')
        }
      }
    };

    const res = await fetch(`${BASE_URL}/api/guardar`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(nuevoRegistro)
    });

    const result = await res.json();
    if (res.ok) {
      alert('Registro guardado con éxito');
      window.open(`${BASE_URL}/api/pdf/${folio}`, '_blank');
    } else {
      alert(result.message || 'Error al guardar');
    }
  });
</script>

<script src="scripts.js"></script>
</body>
</html>
