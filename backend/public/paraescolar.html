<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Selecci√≥n de Paraescolar</title>
<link rel="stylesheet" href="/style.css">
<style>
body {
  font-family: Arial, sans-serif;
}

.container {
  max-width: 700px;
  margin: auto;
  padding: 20px;
}

input, select, button {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
}

fieldset {
  margin-top: 15px;
}

.locked {
  background-color: #eee;
}
</style>
</head>

<body>

<div class="container">

<h2>Registro de Paraescolar</h2>

<form id="registroForm">

<!-- üîç BUSCADOR -->
<div>
  <input type="text" id="numero_control" placeholder="Ingresa tu N√∫mero de Control" required>
  <button type="button" onclick="buscarAlumno()">Buscar</button>
</div>

<!-- üìã DATOS DEL ALUMNO -->
<fieldset>
  <legend>Datos del Alumno</legend>

  <input id="curp" placeholder="CURP" readonly>
  <input id="nombre" placeholder="Nombre Completo" readonly>
  <input id="grado" placeholder="Grado" readonly>
  <input id="grupo" placeholder="Grupo" readonly>

</fieldset>

<!-- üéØ PARAESCOLAR -->
<fieldset>
  <legend>Selecciona Paraescolar</legend>

  <select id="paraescolar" required>
    <option value="">-- Selecciona --</option>
    <option value="AJEDREZ">AJEDREZ</option>
    <option value="ATLETISMO">ATLETISMO</option>
    <option value="BANDA DE GUERRA">BANDA DE GUERRA</option>
    <option value="BASQUETBOL">BASQUETBOL</option>
    <option value="DANZA">DANZA</option>
    <option value="ESCOLTA DE BANDERA">ESCOLTA DE BANDERA</option>
    <option value="FOTOGRAF√çA">FOTOGRAF√çA</option>
    <option value="FUTBOL">FUTBOL</option>
    <option value="PINTURA">PINTURA</option>
    <option value="TEATRO-CANTO">TEATRO-CANTO</option>
    <option value="TOCHO BANDERA">TOCHO BANDERA</option>
    <option value="VOLEIBOL">VOLEIBOL</option>
    <option value="ORATORIA Y DECLAMACI√ìN">ORATORIA Y DECLAMACI√ìN</option>
    <option value="M√öSICA">M√öSICA</option>
  </select>

</fieldset>

<button type="submit">Guardar Paraescolar</button>

</form>

</div>

<script>
let alumno = null;
let guardando = false;

// üîç Buscar alumno
async function buscarAlumno() {
  const controlInput = document.getElementById("numero_control");
  const control = controlInput.value.trim();

  if (!control) {
    alert("‚ö†Ô∏è Ingresa tu n√∫mero de control.");
    controlInput.focus();
    return;
  }

  if (!/^[0-9]{8,20}$/.test(control)) {
    alert("‚ö†Ô∏è El n√∫mero de control debe ser num√©rico.");
    return;
  }

  try {
    const resp = await fetch(`/api/paraescolar/${control}`);
    const data = await resp.json();

    if (data.error) {
      alert("‚ùå Alumno no encontrado.");
      limpiarFormulario();
      return;
    }

    alumno = data;

    curp.value   = data.curp || "";
    nombre.value = data.nombre || "";
    grado.value  = data.grado || "";
    grupo.value  = data.grupo || "";

    if (data.bloqueado) {
      paraescolar.value = data.paraescolar;
      paraescolar.disabled = true;
      alert("‚úÖ Ya tienes un paraescolar asignado.");
    } else {
      paraescolar.disabled = false;
    }

  } catch (error) {
    console.error(error);
    alert("‚ùå Error de conexi√≥n con el servidor.");
  }
}

// üíæ Guardar selecci√≥n
document.getElementById("registroForm").addEventListener("submit", async e => {
  e.preventDefault();

  if (!alumno) return alert("‚ö†Ô∏è Primero busca tu n√∫mero de control.");
  if (!paraescolar.value) return alert("‚ö†Ô∏è Selecciona un paraescolar.");

  if (guardando) return; // evitar doble clic
  guardando = true;

  try {
    const resp = await fetch(`/api/paraescolar/${alumno._id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paraescolar: paraescolar.value })
    });

    const result = await resp.json();

    if (result.error) {
      alert("‚ùå " + result.error);
    } else {
      alert("üéâ Paraescolar registrado correctamente.");
      paraescolar.disabled = true;
    }

  } catch (error) {
    console.error(error);
    alert("‚ùå Error al guardar.");
  } finally {
    guardando = false;
  }
});

function limpiarFormulario() {
  alumno = null;
  curp.value = "";
  nombre.value = "";
  grado.value = "";
  grupo.value = "";
  paraescolar.value = "";
  paraescolar.disabled = true;
}
</script>
</body>
</html>
